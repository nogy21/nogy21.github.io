---
layouts: post

title: "DB&JDBC(07) - 미니프로젝트 - 수업 29일차"

date: 2021-09-08

toc: true

toc_sticky: true

categories:

  #- database

tags:

  #- "database", "java", "수업 복습"
---

<details>
	<summary>이전 복습 키워드<br></summary>
	<div markdown="1">stack | heap | start() | run() | Thread | Synchronized | DBMS | SQL | Middleware | jdbc | DML | CRUD | DDL | DCL | Transaction | con.setAutoCommit() | rollback() | throw | </div>
</details>



첫 날 오후 수업에 설계부터 시작해서 오늘까지 총 이틀에 걸쳐 미니 프로그램을 진행했는데 내일 오전까지 진행해야 완성이 될 것 같습니다.<br>
간단한 기능들을 구현한 프로그램이고 투박해 보이기도 합니다만, 수업을 처음 시작했을 때를 생각해보면 감회가 새로운 것 같습니다.<br>

동료 수강생분들 중에는 전공자분들도 계시고, 코딩을 완전히 처음 접해보신 분들도 계십니다. 물론 코딩이 이미 익숙한 분들에게는 지금의 프로그램에 별다른 감흥이 없으실 수도 있겠지만, 저로서는 수업을 시작한 지 한달이 조금 넘은 이 시점에 이 정도 수준의 프로그램을 만들었다는 것에 소소한 기쁨과 성취감을 느끼며, 새로운 자극이 되는 것 같습니다.<br>

<p align="center"><img src="https://user-images.githubusercontent.com/70495425/131687801-2b295fb7-6e22-4e70-a1ef-a7dc85b96796.png" alt="sun cloud" height="10%" width="10%" /></p>

목차

### <span style="color:yellowgreen">미니 프로젝트(은행 계좌 프로젝트)</span>

* [요구사항 분석](#요구사항분석)
* [설계(class diagram)](#설계)
* [기능 구현](#기능-구현)
  * [step1]()
  * [step2]()
  * [step3]()
  * [step4]()
  * [step5]()
  * [step6]()
  * [step7]()
  * [step8]()

<p align="center"><img src="https://user-images.githubusercontent.com/70495425/131687801-2b295fb7-6e22-4e70-a1ef-a7dc85b96796.png" alt="sun cloud" height="10%" width="10%" /></p>




---
프로그램을 만들기 전에  먼저 요구사항을 분석, 설계한 뒤 프로그램을 구현하도록 하겠습니다.

### <span style="color:yellowgreen">**요구사항분석**</span>

저희가 만들 프로그램의 명칭은 *계좌관리 프로그램*입니다.

요구 사항을 살펴보면 아래와 같습니다.

> - 사용자는 계좌 개설이 가능하다.
>   - 계좌 개설 시 계좌번호, 계좌주명, 비밀번호, 잔액정보가 저장되어야 한다.
>   - 최초 계좌 개설 시 초기 납입액이 1000원 이상이 되어야한다
>   - 계좌번호는 유일해야하고 시스템에서 자동 발급하다
> - 잔액조회는 계좌번호가 존재해야하고 계좌번호에 맞는 비밀번호가 일치해야 한다
> - 입금액, 출금액, 계좌이체액은 모두 0원을 초과해야한다
> - 입금 시 계좌번호, 비밀번호가 일치해야 한다
> - 출금 시 계좌번호, 비밀번호가 일치해야하며 잔액 확인 절차가 필요하다(잔액이 부족하면 안되기에)
> - 계좌이체 시 송금자 및 수금자의 계좌가 존재해야하고 이체액은 0원을 초과해야하며 
>   송금자의 비밀번호 또한 일치해야하고 송금자의 잔액 확인 절차가 필요하다
>   - 송금 및 입금 처리가 정상적으로 수행될 경우에만 이체 처리가 되도록 한다
> - 계좌 잔액이 가장 높은 계좌주명과 잔액을 조회할 수 있다

얼핏 보기에 복잡해 보이는 조건들도 있고, 보자마자 어떤 키워드가 생각나는 조건들도 있으실 겁니다. 저희가 만들어야할 기능들을 추려보자면 아래와 같습니다.


- 주요 업무: 
  1. 계좌 개설
  2. 잔액 조회
  3. 입금
  4. 출금
  5. 계좌 이체
  6. 보유잔액 가장 높은 계좌 정보 조회

<br>



### <span style="color:yellowgreen">**설계**</span>

수업 중에는 제공된 요구사항을 토대로 조별 토의를 진행하였으며 주요 기능을 간략하게 도출해내고, 이를 토대로 starUML 프로그램을 사용해서 Class Diagram으로 설계를 진행했습니다. <br>

<p center><img src="https://user-images.githubusercontent.com/70495425/132310119-f856dbf4-9c9a-4151-af81-6449ff0cbc14.png" alt="image" style="zoom:80%;" /></p>

DB에 입력할 데이터(테이블)는 `bank-project.sql`파일에 작성할텐데 현재 다이어그램 상에는 나타나지 않습니다. 테이블에서 사용되는 컬럼값에 매칭되는 변수들을 `AccountVO` 클래스에 작성했습니다. `accountNo`가 계좌번호이자 SQL에서는 pk값이며 계좌주명은 `name`, 비밀번호는 `password`, 잔액은 `balance`로 명명지었습니다.



`AccountDAO`가 이제 가장 중요한 기능을 담는 클래스인데, 현재 시점에서는 계좌개설, 잔액조회, 입금 메서드만을 구성해 놓았고, 추후 프로그램을 만들면서 차근차근 설계를 완성해갔습니다.



그리고 단위테스트를 진행하기 위해 `TestUnit1`, `TestUnit2`파일이 있는데, 이 역시 기능마다 단위테스트를 진행해야하기 때문에 추가 작성이 필요한 부분이고 아래 세 개의 Exception은 현재 시점에 떠올릴 수 있는 예외 상황을 처리하기 위한 Exception 클래스를 미리 설정했습니다.<br>

---

<br>



---

### <span style="color:yellowgreen">**기능구현**</span>

2번째 기능 - 계좌 조회

- 존재하지 않는 계좌번호 입력
- 잘못된 비번입력

힌트 얻기 전: 조건을 다르게 생각. 

1) SQL문: `SELECT balance FROM account WHERE accountNo=? AND password=?;`
2) 처음에는 if(rs.next) 계좌번호 일치 x -> exception, 비밀번호 불일치 -> exception
   생각해보니 첫번째 라인에만 적용.
3) list에 값들을 집어넣어서 내용 일치를 확인할 생각
   -> `SELECT accountNo, password, balance FROM account;`
   iterator를 사용해서 값을 조회하려 했는데 contain 활용이 안됨
4) 강사님께서 힌트 제공 -> SQL문을 알려주심
   password와 balance를 조회하고 계좌번호를 조건문으로 사용하면 된다고 하심.
   조회가 안될경우 계좌 없음 exception, 조회 가능한 경우 password 불일치 시 exception
5) 

---

3교시

3번째 기능 - 입금

Exception

​	시스템적 문제 -> printStackTrace()

​	메세지 전파 -> getMessage()

feedback

- set_balance 변수 불필요
- `where`문에서 `password`조건 추가 불필요

4번째 기능 - 출금

입금과 흡사합니다.

---

4교시

5번째 기능 - 계좌 이체



---

5교시

findBalance 수정

-> why? 계좌 조회 중 이체 또는 입금 시 문제 발생? 개발자의 편리함을 추구하기 위해 기능을 재사용했지만 좋지 않음

-> 입금과 출금 확인하는 메서드를 따로 생성

​	getConnection() 생성했던 것처럼 메서드를 생성

`checkAccountNoAndPassword()`: 잔액 조회와 유사한 기능이지만 다른 메서드에서 재사용 하기 보다 최적화된 메서드

```java
public void transfer(String remittorAccountNo, String receiverAccountNo, String remittorPassword, int money) throws Exception {
    checkAccountNoAndPassword(remittorAccountNo, remittorPassword);
    if(money<=0)
        throw new NoMoneyException("출금액은 0원보다 많아야 합니다.");
    int remittorBalance = findBalanceByAccountNo(remittorAccountNo, remittorPassword);
    if(money>remittorBalance)
        throw new InsufficientBalanceException("잔액이 부족하여 송금할 수 없습니다.");
    Connection con = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    try {
        con = getConnection();
        con.setAutoCommit(false);
        String sql = "SELECT password FROM account WHERE=?";
        pstmt = con.prepareStatement(sql.toString());
        pstmt.setString(1, receiverAccountNo);
        rs = pstmt.executeQuery();
        if(rs.next()) {                
            withdraw(remittorAccountNo, remittorAccountNo, money);
            deposit(receiverAccountNo, rs.getString(1), money);
        }else {
            throw new AccountNotFoundException("수취인의 계좌가 존재하지 않습니다.");
        }
        con.commit();//실제 DB에 작업 결과 반영
    } catch(Exception e){
        con.rollback();//진행 내용 취소하고 원상태 복구
        throw e;
    }finally {
        closeAll(rs, pstmt, con);
    }
}
```



6번째 기능 - 보유잔액 가장 높은 계좌 정보 조회

---

6교시

---

7교시

<img src="https://user-images.githubusercontent.com/70495425/132500787-b32ff06e-a095-4dc8-acd1-94a392a8df81.png" alt="image" style="zoom:67%;" />

---

8교시	

계좌 존재 유무를 확인하는 메서드를 생성

transfer에서 한참을 씨름했는데

문제는 결국 인자값에 변수이름을 잘못넣어서 생긴 에러였습니다. 이체를 하는 과정에서 출금을 할 때 송금인의 계좌번호와 비밀번호, 이체액을 입력해야 하는데 계좌번호를 두 번 연달아 쓰고는 비밀번호가 잘못되었다는 에러를 보고도 Password가 입력되지 않았다는 것을 못 알아차려서 한참을 헤맸고 다시 찬찬히 살펴본 결과 찾아낼 수 있었습니다.



내일 - Group by, Join

<p align="center"><img src="https://user-images.githubusercontent.com/70495425/131689647-b4d2206e-7ec4-4f7f-a734-6c3bf77c80c3.png" height="10%" width="10%"></p>

