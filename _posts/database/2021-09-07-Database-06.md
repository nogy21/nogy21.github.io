---
layouts: post

title: "DB&JDBC(06) - 서브쿼리 & 미니프로젝트 - 수업 28일차"

date: 2021-09-07

toc: true

toc_sticky: true

categories:

   # - database

tags:

  - "database", "java", "수업 복습"
---





오늘은 `subquery`연습을 한 뒤 미니 프로젝트를 진행할 예정입니다.

- [Subquery 예제](#subquery-예제)
- 미니 프로젝트(은행 계좌)
  * 요구사항분석
  * 설계
  * 기능 구현

<p align="center"><img src="https://user-images.githubusercontent.com/70495425/131687801-2b295fb7-6e22-4e70-a1ef-a7dc85b96796.png" alt="sun cloud" height="10%" width="10%" /></p>



<details>
	<summary>복습 키워드<br></summary>
	<div markdown="1">stack | heap | start() | run() | Thread | Synchronized | DBMS | SQL | Middleware | jdbc | DML | CRUD | DDL | DCL | Transaction | con.setAutoCommit() | rollback() | throw | </div>
</details>

---
### Subquery 예제



연결이 끊겼을 경우 -> ping 확인(이상 있을 시 계속 진행) -> 윈도우에서 서비스 실행 -> OracleServiceXE, OracleServiceXETNSListener 실행

데이터를 직접 신속하게 수정하고 싶을 경우 -> Data Source Explorer -> Oracle -> xe -> Schemas -> username -> Tables에서 수정

test 코드를 작성해서 단위 테스트를 진행하는 연습을 해야 함!



1. 06-jdbc-subquery.sql에서 sql 단위 테스트 진행
2. model 패키지 내에 Employee 생성 
   -> 인스턴스 변수 
   -> 생성자: 1. 기본(단일 등록); 2. 사원번호 제외(insert); 3. 전부(조회)
   -> getter setter -> toString()
3. model 패키지 내에 DbInfo interface 생성
   -> `DRIVER`, `URL`, `ID`, `PASSWORD`를 static final 상수로 생성(인터페이스이므로 field(변수+상수)는 public static final로 인식된다)
4. model 패키지 내에 EmployeeDAO 생성
   -> `드라이버 로딩` -> `closeAll() 메서드 생성, 오버라이딩`

---

3교시

1. test 패키지 생성, TestEmployeeDAO1 클래스 생성

2. register() 메서드를 만들어서 데이터를 저장

3. 해당 job(부서)의 사원 중 가장 높은 salary를 받는 사원 정보를 조회하는 메서드 생성

   3-1. sql 단위 테스트 진행(`subquery` 사용)

   ​	3-1-1. job에 해당하는 사원의 가장 높은 salary를 조회

   ​	: `SELECT MAX(salary) FROM s_employee WHERE job='개발';`

   ​	3-1-2.위 sql에서 조회된 salary를 받는 사원 정보(job에 해당하는 사원에 한함)

   ​	: `SELECT empno, name, job, salary FROM s_employee WHERE job='개발' AND salary=(3-1-1의 sql문)`

   3-2. `ArrayList<Employee>` 타입의 `list`를 생성하고 sql문을 활용하여 데이터를 `list`에 할당합니다.

---

4교시

 이번 예제를 연습하는데 있어서 핵심 내용은 `subquery`의 활용입니다. 하루 전 수업에서 `subquery`를 배웠고 간단한 `sql`문으로 작성을 해봤는데 이를 `java` 프로그램으로 구현하는 부분이기에 보다 자세히 분석해보도록 하겠습니다.

위의 3번 단계를 보시면 sql 단위테스트를 다시 두 번의 단계로 나누어서 진행을 하게 됩니다.

핵심은 `job='개발'`인 `WHERE`절을 두 번 사용해야 한다는 부분입니다. 단순하게 생각했을 경우 가장 높은 `salary`를 받는 `job ='개발'`인 사원 정보를 조회해야 하기에 `MAX(salary)`를 조회하는 단계에서 `WHERE job='개발'` 부분을 빠뜨리기 쉽습니다. 이 경우 다른 부서의 `salary`가 더 높을 때 저희가 원하는 정보를 조회할 수 없게 됩니다. 예를 들어 #?#?

`SELECT * FROM s_employee WHERE job ='개발' AND salary = (SELECT max(salary) FROM s_employee WHERE job = '개발');`

```java
public ArrayList<Employee> getEmployeeListByHighSalAndJob(String job) throws SQLException {
    ArrayList<Employee> list = new ArrayList<Employee>();
    Connection con = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    try {
        con = DriverManager.getConnection(DbInfo.URL, DbInfo.USERNAME, DbInfo.PASSWORD);
        StringBuilder sql = new StringBuilder("SELECT empno, name, job, salary "); 
        sql.append("FROM s_employee ");
        sql.append("WHERE job = ? ");
        sql.append("AND salary = (SELECT max(salary) FROM s_employee WHERE job = ?");
        pstmt = con.prepareStatement(sql.toString());
        pstmt.setString(1, job);
        pstmt.setString(2, job);
        rs = pstmt.executeQuery();
        while(rs.next()) {
            list.add(new Employee(rs.getString(1),rs.getString(2),rs.getString(3),rs.getInt(4)));
        }
    } finally {
        closeAll(rs, pstmt, con);
    }
    return list;
}
```



---

5교시

분석 설계, 요구사항에 따른 프로그램 구현

### bank project

 - sql, jdbc

데이터베이스를 제어하는 DAO를 만들어서 테스트

#### 요구사항분석

계좌관리 프로그램 -> 명칭

사용자는 계좌 개설이 가능하다 
-> CREATE TABLE, INSERT

계좌 개설 시 계좌번호, 계좌주명, 비밀번호, 잔액정보가 저장되어야 한다.
-> CREATE TABLE - 계좌번호(시퀀스), 계좌주명(VARCHAR), 비밀번호(VARCHAR), 잔액정보(NUMBER)
   VO instance value

최초 계좌 개설 시 초기 납입액이 1000원 이상이 되어야한다
-> default 0, exception

계좌번호는 유일해야하고 시스템에서 자동 발급하다
-> SEQUENCE

잔액조회는 계좌번호가 존재해야하고 계좌번호에 맞는 비밀번호가 일치해야 한다
-> exception(?)

입금액, 출금액, 계좌이체액은 모두 0원을 초과해야한다
-> exception(?)

입금 시 계좌번호, 비밀번호가 일치해야 한다
-> 18 line

출금 시 계좌번호, 비밀번호가 일치해야하며 잔액 확인 절차가 필요하다(잔액이 부족하면 안되기에)
-> 18 line, 

계좌이체 시 송금자 및 수금자의 계좌가 존재해야하고
이체액은 0원을 초과해야하며 송금자의 비밀번호 또한 일치해야하고
송금자의 잔액 확인 절차가 필요하다
-> 

송금 및 입금 처리가 정상적으로 수행될 경우에만 이체 처리가 되도록 한다
-> TRANSACTION

계좌 잔액이 가장 높은 계좌주명과 잔액을 조회할 수 있다
-> subquery 연습용


- 주요 업무: 
    1. 계좌 개설
    2. 잔액 조회
    3. 입금
    4. 출금
    5. 계좌 이체
    6. 보유잔액 가장 높은 계좌 정보 조회



#### 설계

조별로 토의, uml-class diagram



---

6교시

요구사항분석 -> 나중에 use case diagram으로 다룰 예정

DDL -> Class diagram -> 기능 구현

DDL

-> CREATE TABLE

-> CREATE SEQUENCE

다음에 ERD(Entity Relationship Database?) 사용 예정



---

7교시

<p center><img src="https://user-images.githubusercontent.com/70495425/132310119-f856dbf4-9c9a-4151-af81-6449ff0cbc14.png" alt="image" style="zoom:80%;" /></p>





---

8교시	



<p align="center"><img src="https://user-images.githubusercontent.com/70495425/131689647-b4d2206e-7ec4-4f7f-a734-6c3bf77c80c3.png" height="10%" width="10%"></p>

